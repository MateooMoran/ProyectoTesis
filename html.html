<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Órdenes Estudiante</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .producto {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }

        .metodo {
            border: 1px solid #aaa;
            padding: 8px;
            margin: 5px 0;
            cursor: pointer;
        }

        button {
            margin-top: 5px;
        }

        input,
        select {
            margin: 5px 0;
            display: block;
        }

        #ordenDiv {
            border: 1px solid #888;
            padding: 10px;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <h1>Productos</h1>

    <label for="tipo">Filtrar métodos de pago (opcional):</label>
    <select id="tipo">
        <option value="">Todos</option>
        <option value="transferencia">Transferencia</option>
        <option value="qr">QR</option>
        <option value="retiro">Retiro</option>
    </select>

    <div id="productos"></div>

    <div id="ordenDiv">
        <h2>Orden Seleccionada</h2>
        <div id="ordenInfo">No hay orden seleccionada</div>
    </div>

    <script>
        const GTOKENS = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4ZTQ3YjkzNTdiMjgxMDNjNzRjMzNmOSIsInJvbCI6ImVzdHVkaWFudGUiLCJpYXQiOjE3NjIwNTAwNjcsImV4cCI6MTc2MjEzNjQ2N30.UOVuuwMlgHPIHKXLAoLrX8EwOk-Xr2LXDTIeK_9nQAU"; // tu token JWT
        const STRIPE_PUBLIC_KEY = "pk_test_51RhiuCQ1P5F6cpxl4rhes8Pmw4O7jeAVrwgs9VBkCF03Rlm7XfGv0OImMFmEaiBQgMVo4OjkwOyyP6495Y1CcTX800b1pHwcqH"; // tu public key de Stripe
        const stripe = Stripe(STRIPE_PUBLIC_KEY);

        const tipoSelect = document.getElementById("tipo");
        const productosDiv = document.getElementById("productos");
        const ordenInfo = document.getElementById("ordenInfo");

        let productos = [];
        let ordenSeleccion = { productoId: null, metodoPagoId: null, cantidad: 1, lugarRetiro: "", vendedorId: null, _id: null };

        // ===================== Cargar productos =====================
        async function cargarProductos() {
            productosDiv.innerHTML = "";
            try {
                const res = await fetch("http://localhost:3000/api/estudiante/productos", {
                    headers: { "Authorization": `Bearer ${GTOKENS}` }
                });
                productos = await res.json();

                productos.forEach(producto => {
                    const div = document.createElement("div");
                    div.classList.add("producto");
                    div.innerHTML = `
            <strong>${producto.nombre}</strong> - $${producto.precio}<br>
            Vendedor: ${producto.vendedor.nombre || 'Sin nombre'}<br>
            <button>Seleccionar Producto</button>
            <div class="metodosContainer"></div>
          `;
                    const btn = div.querySelector("button");
                    const metodosContainer = div.querySelector(".metodosContainer");

                    btn.addEventListener("click", async () => {
                        ordenSeleccion.productoId = producto._id;
                        ordenSeleccion.cantidad = 1;
                        ordenSeleccion.vendedorId = producto.vendedor._id;

                        // Cargar métodos del vendedor
                        metodosContainer.innerHTML = "<p>Cargando métodos...</p>";
                        let url = tipoSelect.value
                            ? `http://localhost:3000/api/vendedor/pago/${tipoSelect.value}?vendedorId=${producto.vendedor._id}`
                            : `http://localhost:3000/api/vendedor/pago?vendedorId=${producto.vendedor._id}`;

                        try {
                            const resMet = await fetch(url, { headers: { "Authorization": `Bearer ${GTOKENS}` } });
                            const data = await resMet.json();
                            metodosContainer.innerHTML = "";
                            data.metodos.forEach(m => {
                                const mDiv = document.createElement("div");
                                mDiv.classList.add("metodo");
                                mDiv.textContent = `Tipo: ${m.tipo} - ${JSON.stringify(m)}`;
                                mDiv.addEventListener("click", () => {
                                    ordenSeleccion.metodoPagoId = m._id;
                                    mostrarOrden();
                                });
                                metodosContainer.appendChild(mDiv);
                            });
                        } catch (err) { metodosContainer.innerHTML = "Error al cargar métodos"; console.error(err); }
                    });

                    productosDiv.appendChild(div);
                });
            } catch (err) {
                productosDiv.innerHTML = "Error al cargar productos";
                console.error(err);
            }
        }

        // ===================== Mostrar orden y acciones =====================
        async function mostrarOrden() {
            if (!ordenSeleccion.productoId || !ordenSeleccion.metodoPagoId) return;

            // Cargar lugares de retiro del vendedor
            let lugaresOptions = "";
            try {
                const resLugares = await fetch(
                    `http://localhost:3000/api/vendedor/pago/retiro?vendedorId=${ordenSeleccion.vendedorId}`,
                    { headers: { "Authorization": `Bearer ${GTOKENS}` } }
                );
                const dataLugares = await resLugares.json();
                if (resLugares.ok && dataLugares.metodos.length > 0) {
                    const lugares = dataLugares.metodos[0].lugares;
                    lugares.forEach(l => {
                        lugaresOptions += `<option value="${l}">${l}</option>`;
                    });
                } else {
                    lugaresOptions = `<option value="">No hay lugares disponibles</option>`;
                }
            } catch (err) {
                console.error(err);
                lugaresOptions = `<option value="">Error al cargar lugares</option>`;
            }

            ordenInfo.innerHTML = `
        <p>Producto ID: ${ordenSeleccion.productoId}</p>
        <p>Método de pago ID: ${ordenSeleccion.metodoPagoId}</p>
        <label>Lugar de retiro:</label>
        <select id="lugarRetiroSelect">${lugaresOptions}</select>
        <label>Cantidad:</label>
        <input type="number" id="cantidadInput" value="1">
        <button id="crearOrdenBtn">Crear Orden</button>

        <div id="comprobanteDiv" style="display:none;">
          <h3>Subir Comprobante</h3>
          <input type="file" id="archivoComprobante">
          <button id="subirComprobanteBtn">Subir Comprobante</button>
        </div>

        <div id="pagoTarjetaDiv" style="display:none;">
          <h3>Pagar con Tarjeta</h3>
          <input type="number" id="montoPago" placeholder="Monto en centavos">
          <button id="pagarTarjetaBtn">Pagar con Tarjeta</button>
        </div>

        <div id="confirmEntregaDiv" style="display:none;">
          <h3>Confirmar Entrega</h3>
          <button id="confirmarEntregaBtn">Confirmar Entrega</button>
        </div>
      `;

            // Crear Orden
            document.getElementById("crearOrdenBtn").addEventListener("click", async () => {
                ordenSeleccion.lugarRetiro = document.getElementById("lugarRetiroSelect").value;
                ordenSeleccion.cantidad = Number(document.getElementById("cantidadInput").value);

                try {
                    const res = await fetch("http://localhost:3000/api/estudiante/orden", {
                        method: "POST",
                        headers: { "Authorization": `Bearer ${GTOKENS}`, "Content-Type": "application/json" },
                        body: JSON.stringify(ordenSeleccion)
                    });
                    const data = await res.json();
                    if (!res.ok) return alert(`Error: ${data.msg}`);
                    alert(`Orden creada con ID: ${data._id}`);

                    document.getElementById("comprobanteDiv").style.display = "block";
                    document.getElementById("pagoTarjetaDiv").style.display = "block";
                    document.getElementById("confirmEntregaDiv").style.display = "block";

                    ordenSeleccion._id = data._id;

                } catch (err) { console.error(err); alert("Error al crear la orden"); }
            });

            // Subir Comprobante
            document.getElementById("subirComprobanteBtn").addEventListener("click", async () => {
                const archivo = document.getElementById("archivoComprobante").files[0];
                if (!archivo) return alert("Selecciona un archivo");

                const formData = new FormData();
                formData.append("comprobante", archivo);

                try {
                    const res = await fetch(`http://localhost:3000/api/estudiante/orden/${ordenSeleccion._id}/comprobante`, {
                        method: "POST",
                        headers: { "Authorization": `Bearer ${GTOKENS}` },
                        body: formData
                    });
                    const data = await res.json();
                    alert(res.ok ? "Comprobante subido" : `Error: ${data.msg}`);
                } catch (err) { console.error(err); alert("Error al subir comprobante"); }
            });

            // Pagar con tarjeta
            document.getElementById("pagarTarjetaBtn").addEventListener("click", async () => {
                const amount = Number(document.getElementById("montoPago").value);
                if (!amount) return alert("Ingresa un monto");

                try {
                    const res = await fetch("http://localhost:3000/api/estudiante/orden/pago-tarjeta", {
                        method: "POST",
                        headers: { "Authorization": `Bearer ${GTOKENS}`, "Content-Type": "application/json" },
                        body: JSON.stringify({ ordenId: ordenSeleccion._id, amount, paymentMethodId: "pm_card_visa_testXXXXXXXX" })
                    });
                    const data = await res.json();
                    if (!res.ok) return alert(`Error: ${data.msg}`);

                    const result = await stripe.confirmCardPayment(data.clientSecret);
                    if (result.error) alert(`Error: ${result.error.message}`);
                    else alert("Pago completado con tarjeta");
                } catch (err) { console.error(err); alert("Error al procesar pago"); }
            });

            // Confirmar Entrega
            document.getElementById("confirmarEntregaBtn").addEventListener("click", async () => {
                try {
                    const res = await fetch(`http://localhost:3000/api/estudiante/orden/${ordenSeleccion._id}/confirmar-entrega`, {
                        method: "PUT",
                        headers: { "Authorization": `Bearer ${GTOKENS}` }
                    });
                    const data = await res.json();
                    alert(res.ok ? "Entrega confirmada" : `Error: ${data.msg}`);
                } catch (err) { console.error(err); alert("Error al confirmar entrega"); }
            });
        }

        // Filtrar métodos recarga productos
        tipoSelect.addEventListener("change", () => {
            cargarProductos();
            ordenInfo.innerHTML = "No hay orden seleccionada";
        });

        monstrarOrden()
        cargarProductos();
    </script>
</body>

</html>