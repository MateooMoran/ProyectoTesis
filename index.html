<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Productos y Métodos de Pago</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .producto { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    .metodo { border: 1px solid #aaa; padding: 8px; margin: 5px 0; }
    button { margin-top: 5px; }
  </style>
</head>
<body>
  <h1>Productos</h1>

  <label for="rol">Selecciona tu rol:</label>
  <select id="rol">
    <option value="vendedor">Vendedor</option>
    <option value="estudiante" selected>Estudiante</option>
  </select>

  <label for="tipo">Filtrar por tipo (opcional):</label>
  <select id="tipo">
    <option value="">Todos</option>
    <option value="transferencia">Transferencia</option>
    <option value="qr">QR</option>
    <option value="retiro">Retiro</option>
  </select>

  <div id="productos"></div>

  <script>
    const GTOKENS = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4ZTQ3YjkzNTdiMjgxMDNjNzRjMzNmOSIsInJvbCI6ImVzdHVkaWFudGUiLCJpYXQiOjE3NjIwNTAwNjcsImV4cCI6MTc2MjEzNjQ2N30.UOVuuwMlgHPIHKXLAoLrX8EwOk-Xr2LXDTIeK_9nQAU"; // reemplaza con tu token real
    const rolSelect = document.getElementById("rol");
    const tipoSelect = document.getElementById("tipo");
    const productosDiv = document.getElementById("productos");

    let vendedorSeleccionado = null;

    // Cargar productos (solo estudiante)
    async function cargarProductos() {
      productosDiv.innerHTML = "";
      if (rolSelect.value !== "estudiante") {
        productosDiv.innerHTML = "<p>No necesitas ver productos como vendedor.</p>";
        return;
      }

      try {
        const res = await fetch("http://localhost:3000/api/estudiante/productos", {
          headers: { "Authorization": `Bearer ${GTOKENS}` }
        });
        const data = await res.json();

        data.forEach(producto => {
          const div = document.createElement("div");
          div.classList.add("producto");
          div.dataset.vendedor = producto.vendedor._id;
          div.innerHTML = `
            <strong>${producto.nombre}</strong> - $${producto.precio}<br>
            Vendedor: ${producto.vendedor.nombre || 'Sin nombre'}<br>
            <button>Ver más</button>
            <div class="metodosContainer"></div>
          `;
          const btn = div.querySelector("button");
          const metodosContainer = div.querySelector(".metodosContainer");

          btn.addEventListener("click", async () => {
            vendedorSeleccionado = producto.vendedor._id;
            metodosContainer.innerHTML = "<p>Cargando métodos...</p>";

            // Llamar al endpoint de métodos de pago
            let url = tipoSelect.value
              ? `http://localhost:3000/api/vendedor/pago/${tipoSelect.value}?vendedorId=${vendedorSeleccionado}`
              : `http://localhost:3000/api/vendedor/pago?vendedorId=${vendedorSeleccionado}`;

            try {
              const res = await fetch(url, {
                headers: { "Authorization": `Bearer ${GTOKENS}` }
              });

              let data;
              try { data = await res.json(); }
              catch { const text = await res.text(); data = { msg: text }; }

              metodosContainer.innerHTML = "";
              if (res.ok && data.metodos) {
                data.metodos.forEach(m => {
                  const mDiv = document.createElement("div");
                  mDiv.classList.add("metodo");
                  mDiv.innerHTML = `Tipo: ${m.tipo}<br>Detalles: ${JSON.stringify(m)}`;
                  metodosContainer.appendChild(mDiv);
                });
              } else {
                metodosContainer.innerHTML = `<p>Error: ${data.msg}</p>`;
              }

            } catch (error) {
              metodosContainer.innerHTML = "<p>Error de conexión</p>";
              console.error(error);
            }
          });

          productosDiv.appendChild(div);
        });

      } catch (error) {
        productosDiv.innerHTML = "Error al cargar productos";
        console.error(error);
      }
    }

    // Cambiar tipo recarga métodos si ya hay vendedor seleccionado
    tipoSelect.addEventListener("change", () => {
      const contenedores = document.querySelectorAll(".metodosContainer");
      contenedores.forEach(c => c.innerHTML = ""); // limpia métodos visibles
    });

    // Cambiar rol recarga productos
    rolSelect.addEventListener("change", () => {
      cargarProductos();
    });

    // Inicial
    cargarProductos();
  </script>
</body>
</html>
